<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sketch Studio AI Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>

    <style>
        /* iOS向けの最適化スタイル */
        body { 
            background-color: #0f172a; 
            color: white; 
            overscroll-behavior: none; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        .grayscale-mode { filter: grayscale(100%); }
        .grid-overlay {
            background-size: 33.3% 33.3%;
            background-image: linear-gradient(to right, rgba(255,255,255,0.2) 1px, transparent 1px), 
                              linear-gradient(to bottom, rgba(255,255,255,0.2) 1px, transparent 1px);
            pointer-events: none;
        }
        .markdown-body h1, .markdown-body h2 { color: #2dd4bf; margin-top: 1em; margin-bottom: 0.5em; font-weight: bold; }
        .markdown-body strong { color: #fbbf24; }
        
        /* ボタンの押し心地をネイティブアプリ風に */
        .btn-press:active { transform: scale(0.96); opacity: 0.9; transition: transform 0.1s; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        const { useState, useEffect, useRef, useCallback } = React;

        const App = () => {
            // --- State Management ---
            // 画像データ: src(表示用URL), b64(AI送信用の生データ)
            const [refImg, setRefImg] = useState({ src: null, b64: null });
            const [sketchImg, setSketchImg] = useState({ src: null, b64: null });
            
            // アプリ設定
            const [apiKey, setApiKey] = useState(localStorage.getItem("gemini_api_key") || "");
            const [showSettings, setShowSettings] = useState(false);
            const [mode, setMode] = useState("draw"); // 'draw' or 'critique'
            
            // AIレスポンス
            const [critique, setCritique] = useState("");
            const [loading, setLoading] = useState({ ai: false, img: false });
            
            // ツール状態
            const [tools, setTools] = useState({ 
                gray: false, 
                grid: false, 
                timer: 0, 
                active: false, 
                showControls: true 
            });

            const refInput = useRef(null);
            const sketchInput = useRef(null);

            // --- Effects ---
            
            // タイマー処理
            useEffect(() => {
                let interval = null;
                if (tools.active) {
                    interval = setInterval(() => {
                        setTools(prev => ({...prev, timer: prev.timer + 1}));
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [tools.active]);

            // アイコン初期化
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            // --- Helpers ---

            // メモリ解放処理（重要：iPhoneでのクラッシュを防ぐ）
            const cleanupImage = (oldSrc) => {
                if (oldSrc && oldSrc.startsWith('blob:')) {
                    URL.revokeObjectURL(oldSrc);
                }
            };

            // ファイル読み込み処理
            const handleFileSelect = async (e, type) => {
                const file = e.target.files[0];
                if (!file) return;

                // 古い画像のメモリを解放
                if (type === 'ref') cleanupImage(refImg.src);
                if (type === 'sketch') cleanupImage(sketchImg.src);

                const src = URL.createObjectURL(file);
                
                // Base64変換（AI用）
                const reader = new FileReader();
                reader.onloadend = () => {
                    if (type === 'ref') setRefImg({ src, b64: reader.result });
                    else setSketchImg({ src, b64: reader.result });
                };
                reader.readAsDataURL(file);
                
                // 画像セット時にファイル入力値をクリア（同じ画像を再度選べるように）
                e.target.value = ''; 
            };

            // ランダムお題取得（堅牢版）
            const fetchRandomImage = async (e) => {
                // イベント伝播を完全に停止
                e.preventDefault();
                e.stopPropagation();

                if (loading.img) return; // 連打防止

                setLoading(prev => ({...prev, img: true}));
                
                // 古い画像を掃除
                cleanupImage(refImg.src);

                try {
                    // Picsumから画像取得（キャッシュバスター付き）
                    // iPhone向けにサイズを少し軽量化 (600x800 -> 500x700)
                    const response = await fetch(`https://picsum.photos/500/700?random=${Date.now()}`);
                    const blob = await response.blob();
                    
                    const src = URL.createObjectURL(blob);
                    const reader = new FileReader();
                    
                    reader.onloadend = () => {
                        setRefImg({ src, b64: reader.result });
                        setLoading(prev => ({...prev, img: false}));
                        // 画像取得成功時にタイマーリセット＆スタート
                        setTools(prev => ({...prev, timer: 0, active: true}));
                    };
                    reader.readAsDataURL(blob);

                } catch (error) {
                    alert("画像の取得に失敗しました。通信状況を確認してください。");
                    setLoading(prev => ({...prev, img: false}));
                }
            };

            // AI添削実行
            const runCritique = async () => {
                if (!apiKey) { setShowSettings(true); return; }
                if (!refImg.b64 || !sketchImg.b64) { alert("お手本と自分の絵の両方をセットしてください"); return; }

                setLoading(prev => ({...prev, ai: true}));
                setCritique(""); // 前の結果をクリア

                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

                    const prompt = `
                    あなたはプロのデッサン講師です。
                    1枚目の画像（お手本）と2枚目の画像（ユーザーのスケッチ）を比較してください。
                    以下の形式で日本語でアドバイスを出力してください：

                    ## 褒めポイント
                    - （良い点を2つ）

                    ## 修正ポイント
                    - （形、比率、明暗などから最も重要な改善点を2つ）

                    ## 次の練習
                    - （具体的な練習方法を1つ）
                    `;

                    const result = await model.generateContent([
                        prompt,
                        { inlineData: { data: refImg.b64.split(',')[1], mimeType: "image/jpeg" } },
                        { inlineData: { data: sketchImg.b64.split(',')[1], mimeType: "image/jpeg" } }
                    ]);

                    const response = await result.response;
                    setCritique(response.text());

                } catch (error) {
                    setCritique(`**エラーが発生しました**\nAPIキーが正しいか確認してください。\n詳細: ${error.message}`);
                } finally {
                    setLoading(prev => ({...prev, ai: false}));
                }
            };

            // 時間フォーマット (MM:SS)
            const formatTime = (s) => `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`;

            // --- Render ---
            return (
                <div className="min-h-screen bg-slate-900 flex flex-col max-w-lg mx-auto relative pb-20 safe-area-inset-bottom">
                    
                    {/* Header */}
                    <div className="px-4 py-3 flex justify-between items-center bg-slate-900/95 backdrop-blur sticky top-0 z-50 border-b border-slate-800">
                        <div className="flex items-center gap-2">
                            <i data-lucide="pen-tool" className="text-teal-400 w-5 h-5"></i>
                            <span className="text-lg font-bold bg-gradient-to-r from-teal-400 to-blue-400 bg-clip-text text-transparent">Sketch Studio</span>
                        </div>
                        <div className="flex gap-2">
                            <button type="button" onClick={() => setMode(mode === "draw" ? "critique" : "draw")} className="btn-press px-3 py-1.5 bg-slate-800 rounded-full text-xs font-bold border border-slate-700 text-slate-300">
                                {mode === "draw" ? "添削モード" : "描画モード"}
                            </button>
                            <button type="button" onClick={() => setShowSettings(!showSettings)} className="btn-press p-2 bg-slate-800 rounded-full text-slate-400 border border-slate-700">
                                <i data-lucide="settings" className="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6" onClick={() => setShowSettings(false)}>
                            <div className="bg-slate-800 p-6 rounded-2xl w-full max-w-sm border border-slate-600 shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h2 className="text-lg font-bold mb-4 text-white flex items-center gap-2">
                                    <i data-lucide="key" className="w-5 h-5 text-yellow-400"></i> APIキー設定
                                </h2>
                                <input 
                                    type="password" 
                                    value={apiKey} 
                                    onChange={(e) => setApiKey(e.target.value)} 
                                    className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white mb-4 focus:ring-2 focus:ring-teal-500 outline-none" 
                                    placeholder="Gemini API Keyを入力" 
                                />
                                <button type="button" onClick={() => {localStorage.setItem("gemini_api_key", apiKey); setShowSettings(false);}} className="btn-press w-full bg-teal-600 text-white py-3 rounded-lg font-bold shadow-lg">
                                    保存して閉じる
                                </button>
                                <p className="text-xs text-slate-400 mt-4 text-center">キーはブラウザ内にのみ保存されます</p>
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <div className="flex-1 p-4 flex flex-col gap-4">
                        
                        {/* === DRAW MODE === */}
                        {mode === "draw" && (
                            <>
                                {/* Canvas Area */}
                                <div className="flex-1 relative bg-black rounded-2xl overflow-hidden flex items-center justify-center border border-slate-700 min-h-[50vh] shadow-inner">
                                    {loading.img ? (
                                        <div className="flex flex-col items-center gap-3 text-teal-400 animate-pulse">
                                            <i data-lucide="loader" className="w-10 h-10 animate-spin"></i>
                                            <span className="text-sm font-bold">お題を選定中...</span>
                                        </div>
                                    ) : refImg.src ? (
                                        <div className="relative w-full h-full flex items-center justify-center">
                                            <img src={refImg.src} className={`max-w-full max-h-full object-contain transition-all duration-300 ${tools.gray ? 'grayscale-mode' : ''}`} alt="Ref" />
                                            {tools.grid && <div className="absolute inset-0 grid-overlay"></div>}
                                        </div>
                                    ) : (
                                        <div className="text-center p-8 opacity-50 flex flex-col items-center">
                                            <i data-lucide="image" className="w-16 h-16 mb-4 text-slate-600"></i>
                                            <p className="text-slate-400 font-medium">お題ボタンを押してスタート</p>
                                        </div>
                                    )}

                                    {/* Action Buttons (Floating) */}
                                    {tools.showControls && (
                                        <div className="absolute bottom-4 right-4 flex gap-3">
                                            <button type="button" onClick={fetchRandomImage} disabled={loading.img} className="btn-press bg-teal-500 hover:bg-teal-400 text-white px-4 py-3 rounded-full shadow-lg backdrop-blur-sm border border-white/10 flex items-center gap-2 font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                                                <i data-lucide="shuffle" className="w-5 h-5"></i>
                                                <span className="text-sm">お題</span>
                                            </button>
                                            <button type="button" onClick={() => refInput.current.click()} className="btn-press bg-slate-700/90 text-white p-3 rounded-full shadow-lg backdrop-blur-sm border border-white/10">
                                                <i data-lucide="upload" className="w-5 h-5"></i>
                                            </button>
                                        </div>
                                    )}
                                    <input type="file" ref={refInput} onChange={e => handleFileSelect(e, 'ref')} className="hidden" accept="image/*" />
                                </div>

                                {/* Controller */}
                                {tools.showControls && (
                                    <div className="bg-slate-800/90 backdrop-blur rounded-2xl p-4 border border-slate-700 shadow-xl animate-fade-in-up">
                                        <div className="text-center mb-4">
                                            <span className={`text-4xl font-mono font-bold tracking-wider ${tools.active ? 'text-teal-400' : 'text-slate-500'}`}>
                                                {formatTime(tools.timer)}
                                            </span>
                                        </div>
                                        <div className="flex justify-between items-center px-2">
                                            <ControlBtn 
                                                icon={tools.active ? "pause" : "play"} 
                                                label={tools.active ? "停止" : "開始"} 
                                                active={tools.active}
                                                color="teal"
                                                onClick={() => setTools(p => ({...p, active: !p.active}))} 
                                            />
                                            <ControlBtn 
                                                icon="rotate-ccw" 
                                                label="リセット" 
                                                onClick={() => setTools(p => ({...p, timer: 0, active: false}))} 
                                            />
                                            <ControlBtn 
                                                icon="eye" 
                                                label="白黒" 
                                                active={tools.gray}
                                                color="purple"
                                                onClick={() => setTools(p => ({...p, gray: !p.gray}))} 
                                            />
                                            <ControlBtn 
                                                icon="grid" 
                                                label="グリッド" 
                                                active={tools.grid}
                                                color="blue"
                                                onClick={() => setTools(p => ({...p, grid: !p.grid}))} 
                                            />
                                        </div>
                                    </div>
                                )}
                                <button type="button" onClick={() => setTools(p => ({...p, showControls: !p.showControls}))} className="text-slate-500 text-xs flex items-center justify-center gap-1 mx-auto py-2 opacity-70">
                                    <i data-lucide={tools.showControls ? "chevron-down" : "chevron-up"} className="w-3 h-3"></i>
                                    {tools.showControls ? "メニューを隠す" : "メニューを表示"}
                                </button>
                            </>
                        )}

                        {/* === CRITIQUE MODE === */}
                        {mode === "critique" && (
                            <div className="flex flex-col gap-4 animate-fade-in">
                                <div className="grid grid-cols-2 gap-3 h-40">
                                    {/* Reference Preview */}
                                    <div className="bg-black rounded-xl border border-slate-700 overflow-hidden relative">
                                        {refImg.src ? <img src={refImg.src} className="w-full h-full object-cover opacity-80" /> : <div className="flex items-center justify-center h-full text-xs text-slate-500">お題なし</div>}
                                        <div className="absolute bottom-0 left-0 bg-black/60 text-white text-[10px] px-2 py-1 font-bold">お手本</div>
                                    </div>
                                    {/* Sketch Upload */}
                                    <div onClick={() => sketchInput.current.click()} className="btn-press bg-slate-800 rounded-xl border-2 border-dashed border-slate-600 flex flex-col items-center justify-center cursor-pointer relative overflow-hidden group hover:bg-slate-750 hover:border-teal-500/50 transition-all">
                                        {sketchImg.src ? (
                                            <img src={sketchImg.src} className="w-full h-full object-cover" />
                                        ) : (
                                            <>
                                                <i data-lucide="upload" className="w-8 h-8 text-slate-400 mb-2 group-hover:text-teal-400"></i>
                                                <span className="text-xs text-slate-400 font-bold">自分の絵</span>
                                            </>
                                        )}
                                        <div className="absolute bottom-0 left-0 bg-teal-900/80 text-teal-100 text-[10px] px-2 py-1 font-bold">自分の絵</div>
                                    </div>
                                    <input type="file" ref={sketchInput} onChange={e => handleFileSelect(e, 'sketch')} className="hidden" accept="image/*" />
                                </div>

                                <button type="button" onClick={runCritique} disabled={loading.ai} className={`btn-press w-full py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-3 text-lg transition-all ${loading.ai ? 'bg-slate-700 text-slate-400' : 'bg-gradient-to-r from-teal-500 to-blue-600 text-white'}`}>
                                    {loading.ai ? (
                                        <><i data-lucide="loader-2" className="animate-spin"></i> 思考中...</>
                                    ) : (
                                        <><i data-lucide="sparkles"></i> 添削を開始する</>
                                    )}
                                </button>

                                {/* Critique Result */}
                                {critique && (
                                    <div className="bg-slate-800/80 rounded-xl p-5 border border-slate-700 shadow-xl">
                                        <div className="flex items-center gap-2 mb-3 border-b border-slate-700 pb-2">
                                            <div className="p-1 bg-teal-500/20 rounded-md">
                                                <i data-lucide="bot" className="w-5 h-5 text-teal-400"></i>
                                            </div>
                                            <span className="font-bold text-teal-100">AIアドバイス</span>
                                        </div>
                                        <div className="markdown-body text-sm text-slate-200 leading-relaxed" dangerouslySetInnerHTML={{__html: marked.parse(critique)}}></div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // UI Component: Control Button
        const ControlBtn = ({ icon, label, onClick, active, color = "slate" }) => {
            const colors = {
                slate: active ? "text-white" : "text-slate-400",
                teal: active ? "text-teal-400" : "text-slate-400",
                purple: active ? "text-purple-400" : "text-slate-400",
                blue: active ? "text-blue-400" : "text-slate-400",
                red: active ? "text-red-400" : "text-slate-400"
            };
            
            const bgs = {
                active: `bg-${color}-500/10 ring-1 ring-${color}-500/50`,
                inactive: "bg-slate-700/30 hover:bg-slate-700/50"
            };

            return (
                <button type="button" onClick={onClick} className={`flex flex-col items-center gap-1.5 w-14 btn-press ${colors[color]}`}>
                    <div className={`p-3 rounded-xl transition-all duration-300 ${active ? bgs.active : bgs.inactive}`}>
                        <i data-lucide={icon} className="w-6 h-6"></i>
                    </div>
                    <span className="text-[10px] font-bold tracking-wide">{label}</span>
                </button>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sketch Studio AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <style>
        body { background-color: #0f172a; color: white; overscroll-behavior: none; font-family: sans-serif; }
        .grayscale-mode { filter: grayscale(100%); }
        .markdown-body h1 { font-size: 1.2em; font-weight: bold; margin-bottom: 0.5em; color: #2dd4bf; }
        .markdown-body h2 { font-size: 1.1em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #2dd4bf; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-body p { margin-bottom: 0.8em; line-height: 1.6; }
        .markdown-body strong { color: #fbbf24; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        const { useState, useEffect, useRef } = React;

        const App = () => {
            // State
            const [refImage, setRefImage] = useState(null); // お手本
            const [sketchImage, setSketchImage] = useState(null); // 自分の絵
            const [apiKey, setApiKey] = useState(localStorage.getItem("gemini_api_key") || "");
            const [showSettings, setShowSettings] = useState(false);
            const [mode, setMode] = useState("draw"); // draw, critique
            const [critique, setCritique] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            
            // Draw Tools
            const [isGrayscale, setIsGrayscale] = useState(false);
            const [showGrid, setShowGrid] = useState(false);
            const [timer, setTimer] = useState(0);
            const [isActive, setIsActive] = useState(false);
            const [showControls, setShowControls] = useState(true);

            // Refs
            const refInputRef = useRef(null);
            const sketchInputRef = useRef(null);

            // Timer Logic
            useEffect(() => {
                let interval = null;
                if (isActive) {
                    interval = setInterval(() => setTimer(t => t + 1), 1000);
                } else if (!isActive && timer !== 0) {
                    clearInterval(interval);
                }
                return () => clearInterval(interval);
            }, [isActive]);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            // Handlers
            const handleSaveKey = () => {
                localStorage.setItem("gemini_api_key", apiKey);
                setShowSettings(false);
                alert("APIキーを保存しました！");
            };

            const handleImageUpload = (e, setter) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => setter(e.target.result);
                    reader.readAsDataURL(file);
                }
            };

            const formatTime = (s) => {
                const mins = Math.floor(s / 60);
                const secs = s % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            // AI Critique Logic
            const runCritique = async () => {
                if (!apiKey) {
                    alert("設定ボタンからGeminiのAPIキーを入力してください！");
                    setShowSettings(true);
                    return;
                }
                if (!refImage || !sketchImage) {
                    alert("お手本と自分の絵、両方をアップロードしてください。");
                    return;
                }

                setIsLoading(true);
                setCritique("");

                try {
                    // Base64処理
                    const refBase64 = refImage.split(',')[1];
                    const sketchBase64 = sketchImage.split(',')[1];

                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

                    const prompt = `
                        あなたはプロのデッサン講師です。
                        1枚目の画像はお手本（リファレンス）、2枚目の画像は生徒が描いたデッサンです。
                        
                        以下の構成で優しく、かつ的確に日本語でアドバイスしてください：
                        1. **良い点**: 素晴らしい部分を2つ褒めてください。
                        2. **改善点**: 形の狂い、明暗のバランス、質感表現などから、最も修正すべき点を2つ挙げてください。
                        3. **具体的な練習法**: 次に何を意識して描くべきか、具体的な練習方法を1つ提案してください。
                    `;

                    const result = await model.generateContent([
                        prompt,
                        { inlineData: { data: refBase64, mimeType: "image/jpeg" } },
                        { inlineData: { data: sketchBase64, mimeType: "image/jpeg" } }
                    ]);

                    const response = await result.response;
                    setCritique(response.text());
                } catch (error) {
                    console.error(error);
                    setCritique("エラーが発生しました。APIキーが正しいか、画像サイズが大きすぎないか確認してください。\n" + error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // Views
            return (
                <div className="min-h-screen bg-slate-900 flex flex-col max-w-lg mx-auto relative pb-20">
                    
                    {/* Header */}
                    <div className="p-4 flex justify-between items-center bg-slate-900/90 backdrop-blur sticky top-0 z-50 border-b border-slate-800">
                        <h1 className="text-xl font-bold bg-gradient-to-r from-teal-400 to-blue-500 bg-clip-text text-transparent">
                            Sketch Studio AI
                        </h1>
                        <div className="flex gap-2">
                            <button onClick={() => setMode(mode === "draw" ? "critique" : "draw")} className="px-3 py-1 bg-slate-800 rounded-full text-xs font-bold border border-slate-700">
                                {mode === "draw" ? "添削モードへ" : "描画モードへ"}
                            </button>
                            <button onClick={() => setShowSettings(!showSettings)} className="p-2 bg-slate-800 rounded-full text-gray-400">
                                <i data-lucide="settings" className="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="absolute inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-slate-800 p-6 rounded-2xl w-full max-w-sm border border-slate-700">
                                <h2 className="text-lg font-bold mb-4 text-white">設定</h2>
                                <label className="block text-sm text-gray-400 mb-2">Gemini API Key</label>
                                <input 
                                    type="password" 
                                    value={apiKey}
                                    onChange={(e) => setApiKey(e.target.value)}
                                    className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white mb-4"
                                    placeholder="AI Studioで取得したキー"
                                />
                                <button onClick={handleSaveKey} className="w-full bg-teal-600 hover:bg-teal-500 text-white py-2 rounded-lg font-bold">
                                    保存して閉じる
                                </button>
                                <p className="text-xs text-gray-500 mt-4 text-center">
                                    ※キーはブラウザ内にのみ保存されます。<br/>Google AI Studioで無料で取得できます。
                                </p>
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <div className="flex-1 p-4 flex flex-col gap-4">
                        
                        {/* Mode: DRAW */}
                        {mode === "draw" && (
                            <>
                                <div className="flex-1 relative bg-black rounded-2xl overflow-hidden flex items-center justify-center border border-slate-700 min-h-[50vh]">
                                    {refImage ? (
                                        <>
                                            <img src={refImage} className={`max-w-full max-h-full object-contain ${isGrayscale ? 'grayscale-mode' : ''}`} />
                                            {showGrid && <div className="absolute inset-0 grid-overlay pointer-events-none" style={{backgroundSize: '33.3% 33.3%', backgroundImage: 'linear-gradient(to right, rgba(255,255,255,0.2) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,0.2) 1px, transparent 1px)'}}></div>}
                                            {showControls && (
                                                <button onClick={() => refInputRef.current.click()} className="absolute bottom-4 right-4 bg-black/60 p-3 rounded-full text-white border border-white/20">
                                                    <i data-lucide="image-plus" className="w-5 h-5"></i>
                                                </button>
                                            )}
                                        </>
                                    ) : (
                                        <div onClick={() => refInputRef.current.click()} className="text-center p-8 cursor-pointer opacity-70">
                                            <i data-lucide="image" className="w-12 h-12 mx-auto mb-2 text-teal-500"></i>
                                            <p>お手本画像をアップロード</p>
                                        </div>
                                    )}
                                    <input type="file" ref={refInputRef} onChange={(e) => handleImageUpload(e, setRefImage)} className="hidden" accept="image/*" />
                                </div>

                                {/* Controls */}
                                {showControls && (
                                    <div className="bg-slate-800/90 rounded-2xl p-4 border border-slate-700">
                                        <div className="text-center text-4xl font-mono font-bold text-teal-400 mb-4">{formatTime(timer)}</div>
                                        <div className="flex justify-between px-2">
                                            <button onClick={() => setIsActive(!isActive)} className="flex flex-col items-center gap-1 text-teal-400">
                                                <i data-lucide={isActive ? "pause" : "play"} className="w-8 h-8"></i>
                                                <span className="text-xs">{isActive ? "停止" : "開始"}</span>
                                            </button>
                                            <button onClick={() => {setIsActive(false); setTimer(0);}} className="flex flex-col items-center gap-1 text-gray-400">
                                                <i data-lucide="rotate-ccw" className="w-8 h-8"></i>
                                                <span className="text-xs">リセット</span>
                                            </button>
                                            <button onClick={() => setIsGrayscale(!isGrayscale)} className={`flex flex-col items-center gap-1 ${isGrayscale ? 'text-purple-400' : 'text-gray-400'}`}>
                                                <i data-lucide="eye" className="w-8 h-8"></i>
                                                <span className="text-xs">白黒</span>
                                            </button>
                                            <button onClick={() => setShowGrid(!showGrid)} className={`flex flex-col items-center gap-1 ${showGrid ? 'text-blue-400' : 'text-gray-400'}`}>
                                                <i data-lucide="grid" className="w-8 h-8"></i>
                                                <span className="text-xs">グリッド</span>
                                            </button>
                                        </div>
                                    </div>
                                )}
                                <div className="text-center">
                                    <button onClick={() => setShowControls(!showControls)} className="text-gray-500 text-sm flex items-center justify-center gap-2 mx-auto mt-2">
                                        <i data-lucide={showControls ? "eye-off" : "eye"} className="w-4 h-4"></i>
                                        {showControls ? "画面を広くする" : "メニューを表示"}
                                    </button>
                                </div>
                            </>
                        )}

                        {/* Mode: CRITIQUE */}
                        {mode === "critique" && (
                            <div className="animate-fade-in flex flex-col gap-4">
                                <div className="grid grid-cols-2 gap-2 h-40">
                                    {/* お手本プレビュー */}
                                    <div className="bg-black rounded-lg border border-slate-700 overflow-hidden relative">
                                        {refImage ? <img src={refImage} className="w-full h-full object-cover opacity-80" /> : <div className="flex items-center justify-center h-full text-xs text-gray-500">お手本なし</div>}
                                        <div className="absolute bottom-0 left-0 bg-black/60 text-white text-[10px] px-2 py-1">お手本</div>
                                    </div>
                                    {/* 自分の絵アップロード */}
                                    <div onClick={() => sketchInputRef.current.click()} className="bg-slate-800 rounded-lg border-2 border-dashed border-slate-600 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-700 relative overflow-hidden">
                                        {sketchImage ? (
                                            <img src={sketchImage} className="w-full h-full object-cover" />
                                        ) : (
                                            <>
                                                <i data-lucide="upload" className="w-8 h-8 text-gray-400 mb-1"></i>
                                                <span className="text-xs text-gray-400">自分の絵</span>
                                            </>
                                        )}
                                        <div className="absolute bottom-0 left-0 bg-teal-900/80 text-teal-100 text-[10px] px-2 py-1">自分の絵</div>
                                    </div>
                                    <input type="file" ref={sketchInputRef} onChange={(e) => handleImageUpload(e, setSketchImage)} className="hidden" accept="image/*" />
                                </div>

                                <button 
                                    onClick={runCritique}
                                    disabled={isLoading}
                                    className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 ${isLoading ? 'bg-slate-700 text-gray-400' : 'bg-gradient-to-r from-teal-500 to-blue-600 text-white'}`}
                                >
                                    {isLoading ? (
                                        <>
                                            <i data-lucide="loader-2" className="animate-spin"></i> 思考中...
                                        </>
                                    ) : (
                                        <>
                                            <i data-lucide="sparkles"></i> 添削を開始する
                                        </>
                                    )}
                                </button>

                                {/* 結果表示エリア */}
                                {critique && (
                                    <div className="bg-slate-800/80 rounded-xl p-4 border border-slate-700 shadow-xl">
                                        <div className="flex items-center gap-2 mb-3 border-b border-slate-700 pb-2">
                                            <i data-lucide="bot" className="text-teal-400"></i>
                                            <span className="font-bold text-teal-100">Gemini先生のアドバイス</span>
                                        </div>
                                        <div className="markdown-body text-sm text-gray-200" dangerouslySetInnerHTML={{__html: marked.parse(critique)}}></div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
